(function(){var t,n={}.hasOwnProperty,o=function(t,o){function e(){this.constructor=t}for(var i in o)n.call(o,i)&&(t[i]=o[i]);return e.prototype=o.prototype,t.prototype=new e,t.__super__=o.prototype,t};!function(t,n){return"object"==typeof exports?module.exports=n.call(t):"function"==typeof define&&define.amd?define(function(){return n.call(t)}):t.evo=n.call(t)}(null!=(t="undefined"!=typeof window&&null!==window)?t:{window:this},function(){var t,n,e,i,r,s;return s={},s.config={pool:{n_genes:200,cross_rate:.04,mutate_rate:.04,mutate_amount:.1,size:100,ratios:{top:.2,mutate:.2,cross:.3,random:.05,meld:.2},on_breed:function(){},on_spawn:void 0},network:{hidden_layers:2,hidden_nodes:4,output_nodes:3,input_nodes:2}},s.util={random:function(t,n){return null==t&&(t=-1),null==n&&(n=1),Math.random()*(n-t)+t},sin:function(t,n,o){return null==n&&(n=1),null==o&&(o=0),Math.sin(t*n*6.2832+o)},gaussian:function(t,n,o){return Math.exp(-Math.pow(n-t,2)*o)},linear:function(t,n,o){return(t+o)*n},flatten:function(t){return t>1?1:-1>t?-1:t},tanh:function(t){var n,o;return-3>t||t>3?s.util.flatten(t):(n=Math.exp(t),o=Math.exp(-t),(n-o)/(n+o))},sample:function(t){return t[Math.floor(Math.random()*t.length)]},shuffle:function(t){var n,o,e,i,r,s;for(o=t.length,i=Array(o),n=r=0,s=o-1;s>=0?s>=r:r>=s;n=s>=0?++r:--r)e=Math.floor(Math.random()*n),e!==n&&(i[n]=i[e]),i[e]=t[n];return i},clone:function(t){var n,o;if(null===t||"object"!=typeof t)return t;o=t.constructor();for(n in t)t.hasOwnProperty(n)&&(o[n]=t[n]);return o},extend:function(t,n){var o;if(t=s.util.clone(t),null==n)return t;for(o in n)n[o]&&n[o].constructor&&n[o].constructor===Object?(t[o]=t[o]||{},arguments.callee(t[o],n[o])):t[o]=n[o];return t}},t=function(){function t(){}return t.prototype.config={},t.prototype.on=function(t,n){return this.config["on_"+t]=n,this},t.prototype.trigger=function(t,n){return null==n&&(n=null),null!=this.config["on_"+t]?this.config["on_"+t].call(this,n):void 0},t}(),r=function(t){function n(t){var n,o,e;for(this.config=t,this.generation=0,this.pool=[],this.breedpool=[],this.last_genes={},n=o=1,e=this.config.size;e>=1?e>=o:o>=e;n=e>=1?++o:--o)this.pool.push(this.fresh());this.prev_pool=this.pool.slice(0),this.average=0}return o(n,t),n.prototype.fresh=function(){var t,n,o,e;for(e=[],t=n=1,o=this.config.n_genes;o>=1?o>=n:n>=o;t=o>=1?++n:--n)e.push(s.util.random()*this.config.mutate_amount);return e},n.prototype.clone=function(t){return t.slice(0)},n.prototype.mutate=function(t){var n,o,e,i,r;for(e=[],o=i=0,r=t.length;r>i;o=++i)n=t[o],e[o]=t[o],Math.random()<this.config.mutate_rate&&(e[o]+=s.util.random()*this.config.mutate_amount);return e},n.prototype.cross=function(t,n){var o,e,i,r,s,u;for(r=[],o=!1,i=s=0,u=t.length;u>s;i=++s)e=t[i],Math.random()<this.config.cross_rate&&(o=!o),r.push(o?t[i]:n[i]);return r},n.prototype.meld=function(t,n){var o,e,i,r,s;for(i=[],e=r=0,s=t.length;s>r;e=++r)o=t[e],i.push((t[e]+n[e])/2);return i},n.prototype.spawn=function(){var t,n;return t=this.next(),n=this.trigger("spawn",t),n.genes=t,n.score=0,n.report=function(t){return function(){return t.report(n)}}(this),n},n.prototype.next=function(){if(0===this.pool.length){if(!(this.breedpool.length>0))return this.last=this.fresh();this.generate()}return this.last=this.pool.pop()},n.prototype.report=function(t,n){return null==n&&(n=0),null!=t.score&&null!=t.genes&&(n=t.score,t=t.genes),null==t&&(t=this.last_genes),this.breedpool.push({genes:t,score:n})},n.prototype.mean=function(t){var n,o,e,i;for(o=0,e=0,i=t.length;i>e;e++)n=t[e],o+=n.score;return o/=t.length},n.prototype.generate=function(){var t,n,o,e,i,r,u,h,l,f,p,c,a,d,g,_;for(this.pool=[],this.average=this.mean(this.breedpool),this.breedpool=this.breedpool.sort(function(t,n){return t.score-n.score}),r=this.breedpool.reverse().slice(0,+(this.config.ratios.top*this.config.size)+1||9e9),i=this.config.size,1>i&&(i=0),u=0,p=r.length;p>u;u++)t=r[u],this.pool.push(this.clone(t.genes));for(e=h=1,a=this.config.ratios.mutate*i;a>=1?a>=h:h>=a;e=a>=1?++h:--h)this.pool.push(this.mutate(s.util.sample(r).genes));for(e=l=1,d=this.config.ratios.cross*i;d>=1?d>=l:l>=d;e=d>=1?++l:--l)n=s.util.sample(r).genes,o=s.util.sample(r).genes,this.pool.push(this.cross(n,o));for(e=f=1,g=this.config.ratios.meld*i;g>=1?g>=f:f>=g;e=g>=1?++f:--f)n=s.util.sample(r).genes,o=s.util.sample(r).genes,this.pool.push(this.meld(n,o));for(e=c=1,_=this.config.ratios.random*i;_>=1?_>=c:c>=_;e=_>=1?++c:--c)this.pool.push(this.clone(s.util.sample(this.breedpool).genes));for(;this.pool.length<i;)this.pool.push(this.fresh());return this.generation++,this.prev_pool=this.pool.map(function(t){return t.map(function(t){return Math.round(100*t)/100})}),this.pool=s.util.shuffle(this.pool),this.trigger("breed"),this.breedpool=[]},n.prototype.load=function(t){return this.pool=t.slice(0),this.breedpool=[]},n}(t),s.pool=function(t){return t=s.util.extend(s.config.pool,t),new r(t)},i=function(){function t(t,n){this.config=n}return t.prototype.calc=function(){},t}(),n=function(t){function n(t,n){var o,e,i,r,s,u,h;for(this.config=n,this.node_fn=[],o=t.slice(0),e=r=0,u=this.config.hidden_layers-1;u>=0?u>=r:r>=u;e=u>=0?++r:--r)for(this.node_fn[e]=[],i=s=0,h=this.config.hidden_nodes-1;h>=0?h>=s:s>=h;i=h>=0?++s:--s)this.node_fn[e].push(this.get_fn(o.pop()));this.weights=o.slice(0)}return o(n,t),n.node_fn=[s.util.gaussian,s.util.sin,function(t,n,o){return s.util.tanh(s.util.linear(t,n,o))}],n.prototype.get_fn=function(t){var o;return o=Math.round(Math.abs(t)*n.node_fn.length)%n.node_fn.length,n.node_fn[o]},n.prototype.calc=function(t){var n,o,e,i,r,u,h,l,f,p,c,a,d,g,_,m,y,v,w,b,M,x,z,j,k,O;for(u=this.config.hidden_nodes,n=this.weights.slice(0),o=[],r=f=0,w=this.config.hidden_layers-1;w>=0?w>=f:f>=w;r=w>=0?++f:--f)for(o[r]=[],e=p=0,b=this.config.hidden_nodes-1;b>=0?b>=p:p>=b;e=b>=0?++p:--p)o[r][e]=0;for(c=0,d=t.length;d>c;c++)for(l=t[c],e=a=0,M=this.config.hidden_nodes-1;M>=0?M>=a:a>=M;e=M>=0?++a:--a)o[0][e]+=l*n.pop();for(r=g=0,x=this.config.hidden_layers-2;x>=0?x>=g:g>=x;r=x>=0?++g:--g)for(e=_=0,z=this.config.hidden_nodes-1;z>=0?z>=_:_>=z;e=z>=0?++_:--_)if(o[r][e]=this.node_fn[r][e](o[r][e],n.pop(),n.pop()),r+1<this.config.hidden_layers)for(i=m=0,j=this.config.hidden_nodes-1;j>=0?j>=m:m>=j;i=j>=0?++m:--m)o[r+1][i]+=o[r][e]*n.pop();for(h=[],i=y=0,k=this.config.output_nodes-1;k>=0?k>=y:y>=k;i=k>=0?++y:--y){for(h[i]=0,e=v=0,O=this.config.hidden_nodes-1;O>=0?O>=v:v>=O;e=O>=0?++v:--v)h[i]+=o[this.config.hidden_layers-1][e]*n.pop();h[i]=s.util.tanh(h[i])}return h},n}(i),e=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return o(n,t),n.prototype.calc=function(t){var n,o,e,i,r,u,h,l,f,p,c,a,d,g,_,m,y,v,w,b,M;if(t.length!==this.config.input)throw Error("Inputs dont match. Expected: "+this.config.input+", Received: "+t.length);for(n=this.weights.slice(0),e=[],r=l=0,b=this.config.hidden_nodes-1;b>=0?b>=l:l>=b;r=b>=0?++l:--l)e[r]=0;for(h=[],r=f=0,M=this.config.output_nodes-1;M>=0?M>=f:f>=M;r=M>=0?++f:--f)h[r]=0;for(p=0,a=t.length;a>p;p++)for(i=t[p],r=c=0,d=e.length;d>c;r=++c)o=e[r],e[r]+=i*n.pop();for(i=y=0,g=e.length;g>y;i=++y)for(o=e[i],e[i]+=n.pop(),e[i]=s.util.tanh(e[i]),r=v=0,_=h.length;_>v;r=++v)u=h[r],h[r]+=e[i]*n.pop();for(i=w=0,m=h.length;m>w;i=++w)u=h[i],h[i]=s.util.flatten(h[i]);return h},n}(i),s.network=function(t,o,i){return i=s.util.extend(s.config.network,i),"feedforward"===t?new e(o,i):"cppn"===t?new n(o,i):void 0},s})}).call(this);
