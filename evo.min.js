/**
 * evo.js v0.1.0
 * Genetic Algorithm Calculator with ANN
 * Copyright (c) 2015 Alex Rowe <aprowe@ucsc.edu>
 * Licensed MIT
 **/
(function(){var a,b=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},c={}.hasOwnProperty;a="undefined"!=typeof window&&null!==window?window:this,function(b){return"object"==typeof exports?module.exports=b.call(a):"function"==typeof define&&define.amd?define(function(){return b.call(a)}):a.evo=b.call(a)}(function(){var a,c,d,e,f,g;return g={},g.config={pool:{n_genes:200,cross_rate:.05,mutate_rate:.05,mutate_amount:1,size:100,autospawn:!1,ratios:{top:.25,mutate:.25,cross:.25,random:.1,meld:0,fresh:.15},on_breed:function(){},on_spawn:void 0,on_run:function(){},on_finish:function(){}},network:{output_fn:"tanh",output_nodes:2,hidden_layers:2,hidden_nodes:2,input_nodes:2}},g.configure=function(a){return g.config=g.util.extend(g.config,a)},g.util={random:function(a,b){return null==a&&(a=-1),null==b&&(b=1),Math.random()*(b-a)+a},sin:function(a,b,c){return null==b&&(b=1),null==c&&(c=0),Math.sin(a*b*6.2832+c)},gaussian:function(a,b,c){return null==b&&(b=0),null==c&&(c=1),Math.exp(-Math.pow(b-a,2)*c)},linear:function(a,b,c){return null==b&&(b=1),null==c&&(c=0),(a+c)*b},flatten:function(a){return a>1?1:-1>a?-1:a},tanh:function(a){var b,c;return-3>a||a>3?g.util.flatten(a):(b=Math.exp(a),c=Math.exp(-a),(b-c)/(b+c))},step:function(a){return 0>a?-1:1},sample:function(a){return a[Math.floor(Math.random()*a.length)]},shuffle:function(a){var b,c,d,e,f,g;for(d=a.length,g=Array(d),b=c=0,f=d-1;f>=0?f>=c:c>=f;b=f>=0?++c:--c)e=Math.floor(Math.random()*b),e!==b&&(g[b]=g[e]),g[e]=a[b];return g},clone:function(a){var b,c;if(null===a||"object"!=typeof a)return a;c=a.constructor();for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c},extend:function(a,b){var c;if(a=g.util.clone(a),null==b)return a;for(c in b)b[c]&&b[c].constructor&&b[c].constructor===Object?(a[c]=a[c]||{},a[c]=arguments.callee(a[c],b[c])):a[c]=b[c];return a},normalize:function(a){var b,c,d,e;d=0;for(b in a)e=a[b],d+=e;c={};for(b in a)e=a[b],e||(e=0),c[b]=e/d;return c}},a=function(){function a(){}return a.prototype.config={},a.prototype.on=function(a,b){return this.config["on_"+a]=b,this},a.prototype.trigger=function(a,b){return null==b&&(b=null),null!=this.config["on_"+a]?this.config["on_"+a].call(this,b):void 0},a}(),g.pool=function(a){return a=g.util.extend(g.config.pool,a),new f(a)},f=function(a){function c(a){var b,c,d;for(this.config=a,this.generation=0,this.pool=[],this.breedpool=[],b=c=1,d=this.config.size;d>=1?d>=c:c>=d;b=d>=1?++c:--c)this.pool.push(this.fresh());this.prev_pool=this.pool.slice(0),this.average=0}return b(c,a),c.prototype.seed=function(){return g.util.random()*this.config.mutate_amount},c.prototype.fresh=function(){var a,b,c,d;for(d=[],a=b=1,c=this.config.n_genes;c>=1?c>=b:b>=c;a=c>=1?++b:--b)d.push(this.seed());return d},c.prototype.clone=function(a){return a.slice(0)},c.prototype.mutate=function(a){var b,c,d,e,f;for(f=[],c=d=0,e=a.length;e>d;c=++d)b=a[c],f[c]=a[c],Math.random()<this.config.mutate_rate&&(f[c]+=g.util.random()*this.config.mutate_amount);return f},c.prototype.cross=function(a,b){var c,d,e,f,g,h;for(h=[],c=!1,e=f=0,g=a.length;g>f;e=++f)d=a[e],Math.random()<this.config.cross_rate&&(c=!c),h.push(c?a[e]:b[e]);return h},c.prototype.meld=function(a,b){var c,d,e,f,g;for(g=[],d=e=0,f=a.length;f>e;d=++e)c=a[d],g.push((a[d]+b[d])/2);return g},c.prototype.spawn=function(a){var b;if(null==a&&(a=null),null==a&&(a=this.next()),b=this.trigger("spawn",a),null==b)throw"Spawn trigger did not return an object";return b.genes=a,b.score=0,b.report_to_pool=function(a){return function(){return a.report(b)}}(this),b},c.prototype.next=function(){if(0===this.pool.length){if(!(this.breedpool.length>0))return this.fresh();this.generate()}return this.pool.pop()},c.prototype.report=function(a,b){return null==b&&(b=0),null!=a.score&&null!=a.genes&&(b=a.score,a=a.genes),this.breedpool.push({genes:a,score:b})},c.prototype.run=function(a){var b,c,d,e;for("number"==typeof a?(c=a+this.generation,this.config.on_stop=function(){return this.generation>=c}):"function"==typeof a&&(this.config.on_stop=a);!this.trigger("stop");)this.config.autospawn&&null!=this.config.on_spawn?(e=this.spawn(),this.trigger("run",e),this.report(e)):this.config.autospawn?(b=this.next(),d=this.trigger("run",b),this.report(b,d)):this.trigger("run");return this.trigger("finish")},c.prototype.mean=function(a){var b,c,d,e;for(c=0,d=0,e=a.length;e>d;d++)b=a[d],c+=b.score;return c/=a.length},c.prototype.generate=function(){var a,b,c,d,e,f,h,i,j,k,l,m,n,o,p,q,r;for(l=g.util.normalize(this.config.ratios),this.pool=[],this.average=this.mean(this.breedpool),this.breedpool=this.breedpool.sort(function(a,b){return a.score-b.score}),r=this.breedpool.reverse().slice(0,+(this.config.ratios.top*this.config.size)+1||9e9),q=this.config.size,1>q&&(q=0),e=0,f=r.length;f>e;e++)a=r[e],this.pool.push(this.clone(a.genes));if(l.mutate>0)for(d=h=1,m=l.mutate*q;m>=1?m>=h:h>=m;d=m>=1?++h:--h)this.pool.push(this.mutate(g.util.sample(r).genes));if(l.cross>0)for(d=i=1,n=l.cross*q;n>=1?n>=i:i>=n;d=n>=1?++i:--i)b=g.util.sample(r).genes,c=g.util.sample(r).genes,this.pool.push(this.cross(b,c));if(l.meld>0)for(d=j=1,o=l.meld*q;o>=1?o>=j:j>=o;d=o>=1?++j:--j)b=g.util.sample(r).genes,c=g.util.sample(r).genes,this.pool.push(this.meld(b,c));if(l.random>0)for(d=k=1,p=l.random*q;p>=1?p>=k:k>=p;d=p>=1?++k:--k)this.pool.push(this.clone(g.util.sample(this.breedpool).genes));for(;this.pool.length<q;)this.pool.push(this.fresh());return this.generation++,this.prev_pool=this.pool.slice(0),this.pool=g.util.shuffle(this.pool),this.trigger("breed"),this.breedpool=[]},c.prototype.best=function(a){return null==a?this.prev_pool[0]:this.prev_pool.slice(0,+(a-1)+1||9e9)},c.prototype.load=function(a){return this.pool=a.slice(0),this.breedpool=[]},c}(a),e=function(){function a(a,b){this.weights=a,this.config=b}return a.prototype.calc=function(){},a}(),g.network=function(a,b,e){return e=g.util.extend(g.config.network,e),"feedforward"===a?new d(b,e):"cppn"===a?new c(b,e):void 0},c=function(a){function c(a,b){var c,d,e,f,g,h,i;for(this.config=b,this.node_fn=[],c=a.slice(0),d=f=0,h=this.config.hidden_layers-1;h>=0?h>=f:f>=h;d=h>=0?++f:--f)for(this.node_fn[d]=[],e=g=0,i=this.config.hidden_nodes-1;i>=0?i>=g:g>=i;e=i>=0?++g:--g)this.node_fn[d].push(this.get_fn(c.pop()));this.weights=c.slice(0)}return b(c,a),c.node_fn=[g.util.gaussian,g.util.sin,function(a,b,c){return g.util.tanh(g.util.linear(a,b,c))}],c.prototype.get_fn=function(a){var b;return b=Math.round(Math.abs(a)*c.node_fn.length)%c.node_fn.length,c.node_fn[b]},c.prototype.calc=function(a){var b,c,d,e,f,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;for(i=this.config.hidden_nodes,b=this.weights.slice(0),c=[],f=h=0,p=this.config.hidden_layers-1;p>=0?p>=h:h>=p;f=p>=0?++h:--h)for(c[f]=[],d=k=0,q=this.config.hidden_nodes-1;q>=0?q>=k:k>=q;d=q>=0?++k:--k)c[f][d]=0;for(m=0,j=a.length;j>m;m++)for(B=a[m],d=n=0,r=this.config.hidden_nodes-1;r>=0?r>=n:n>=r;d=r>=0?++n:--n)c[0][d]+=B*b.pop();for(f=o=0,s=this.config.hidden_layers-2;s>=0?s>=o:o>=s;f=s>=0?++o:--o)for(d=x=0,t=this.config.hidden_nodes-1;t>=0?t>=x:x>=t;d=t>=0?++x:--x)if(c[f][d]=this.node_fn[f][d](c[f][d],b.pop(),b.pop()),f+1<this.config.hidden_layers)for(e=y=0,u=this.config.hidden_nodes-1;u>=0?u>=y:y>=u;e=u>=0?++y:--y)c[f+1][e]+=c[f][d]*b.pop();for(l=[],e=z=0,v=this.config.output_nodes-1;v>=0?v>=z:z>=v;e=v>=0?++z:--z){for(l[e]=0,d=A=0,w=this.config.hidden_nodes-1;w>=0?w>=A:A>=w;d=w>=0?++A:--A)l[e]+=c[this.config.hidden_layers-1][d]*b.pop();l[e]=g.util.tanh(l[e])}return l},c}(e),d=function(a){function c(a,b){this.weights=a,this.config=b,this.output_fn="function"==typeof this.config.output_fn?this.config.output_fn:"linear"===this.config.output_fn?g.util.linear:"step"===this.config.output_fn?g.util.step:g.util.tanh}return b(c,a),c.prototype.calc=function(a){var b,c,d,e,f,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;if(a.length!==this.config.input_nodes)throw Error("Inputs dont match. Expected: "+this.config.input_nodes+", Received: "+a.length);for(b=this.weights.slice(0).reverse(),d=[],f=h=0,t=this.config.hidden_nodes-1;t>=0?t>=h:h>=t;f=t>=0?++h:--h)d[f]=0;for(p=[],f=n=0,u=this.config.output_nodes-1;u>=0?u>=n:n>=u;f=u>=0?++n:--n)p[f]=0;for(q=0,i=a.length;i>q;q++)for(e=a[q],f=r=0,j=d.length;j>r;f=++r)c=d[f],d[f]+=e*b.pop();for(e=s=0,k=d.length;k>s;e=++s)for(c=d[e],d[e]+=b.pop(),d[e]=g.util.tanh(d[e]),f=v=0,l=p.length;l>v;f=++v)o=p[f],p[f]+=d[e]*b.pop();for(e=w=0,m=p.length;m>w;e=++w)o=p[e],p[e]=this.output_fn(p[e]);return 1===p.length?p[0]:p},c}(e),g})}).call(this);